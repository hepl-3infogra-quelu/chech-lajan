!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a){"use strict";var b=a("jquery"),c=a("fastclick"),d=a("./router");window.app.now=new Date,b(function(){c(document.body),console.log(window.app),console.log("ready."),window.app.router=new d,window.app.router.start()})},{"./router":4,fastclick:"fastclick",jquery:"jquery"}],2:[function(a,b){"use strict";var c=(a("underscore"),a("jquery"),a("backbone"));c.$=a("jquery"),b.exports=c.Collection.extend({url:"/api/terminals",model:a("../models/terminal"),parse:function(a){return a.data}})},{"../models/terminal":3,backbone:"backbone",jquery:"jquery",underscore:"underscore"}],3:[function(a,b){"use strict";var c=(a("underscore"),a("jquery"),a("backbone"));b.exports=c.Model.extend({urlRoot:"/api/terminals",parse:function(a){return a.data&&a.url?a.data:a}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],4:[function(a,b){"use strict";var c=(a("underscore"),a("jeolok")),d=a("backbone");d.$=a("jquery");var e,f=a("./views/main"),g=a("./views/header"),h=a("./views/map"),i=a("./views/terminals-list"),j=a("./views/terminal-details"),k=a("./models/terminal"),l=a("./collections/terminals");b.exports=d.Router.extend({views:{},routes:{"terminals/list/:radius/:latitude/:longitude":"showTerminalsList","terminals/details/:id":"showTerminalDetails","":"showTerminalsList"},start:function(){(this.views.main=new f).render(),this.views.main.initHeader((this.views.header=new g).render());var a=this;c.getCurrentPosition({enableHighAccuracy:!0},function(b,c){b?(console.log("oups.."),e={latitude:50.84274,longitude:4.35154}):e=c.coords,window.app.currentPosition=e,window.app.currentRadius=5,a.views.main.initMap(window.app.map=new h(e)),d.history.start({})})},showTerminalsList:function(a,b,c){console.log("showTerminalsList");var d=this;this.views.main.loading(!0);var f=new l;(this.views.list=new i(f)).collection.fetch({data:{latitude:b?b:e.latitude,longitude:c?c:e.longitude,radius:a?a:window.app.currentRadius},success:function(){d.views.main.clearContent(),d.views.main.initList(d.views.list.render()),d.views.list.setStatus(f.length+" résultats")}})},showTerminalDetails:function(a){console.log("showTerminalDetails:",a);var b=this;this.views.main.loading(!0);var c=new k({id:a});(this.views.details=new j(c)).model.fetch({success:function(){b.views.main.clearContent(),b.views.main.initDetails(b.views.details.render()),b.views.main.loading(!1)}})}})},{"./collections/terminals":2,"./models/terminal":3,"./views/header":5,"./views/main":6,"./views/map":7,"./views/terminal-details":8,"./views/terminals-list":10,backbone:"backbone",jeolok:"jeolok",jquery:"jquery",underscore:"underscore"}],5:[function(a,b){"use strict";var c=(a("underscore"),a("jeolok")),d=a("jquery"),e=a("backbone");e.$=a("jquery");var f;b.exports=e.View.extend({el:"<div />",constructor:function(){e.View.apply(this,arguments),console.log("HeaderView:init()"),f||(f=d("#tpl-header").remove().text())},events:{"click #refresh":"refreshPosition","click #list":"showList"},render:function(){return this.$el.html(f),this},refreshPosition:function(a){a.preventDefault();var b;c.getCurrentPosition({enableHighAccuracy:!0},function(a,c){a?(console.log("oups.."),b={latitude:50.84274,longitude:4.35154}):b=c.coords,window.app.currentPosition=b,window.app.map.refresh(b),window.app.router.navigate("",!0)})},showList:function(a){a.preventDefault(),window.app.router.navigate("terminals/list/"+window.app.currentRadius+"/"+window.app.currentPosition.latitude+"/"+window.app.currentPosition.longitude,!0)}})},{backbone:"backbone",jeolok:"jeolok",jquery:"jquery",underscore:"underscore"}],6:[function(a,b){"use strict";var c=(a("underscore"),a("jquery")),d=a("backbone");d.$=a("jquery"),b.exports=d.View.extend({el:"body",$el:c("body"),constructor:function(){d.View.apply(this,arguments),console.log("MainView:init()")},loading:function(){},clearContent:function(){this.$el.find("#main aside:not(#map-canvas)").remove();for(var a=0;a<window.app.map.markers.length;a++)window.app.map.markers[a].title||window.app.map.markers[a].setMap(null);window.app.map.markers=new Array},initHeader:function(a){this.$el.find("#header").append(a.$el)},initList:function(a){this.$el.find("#main").prepend(a.$el)},initDetails:function(a){this.$el.find("#main").prepend(a.$el)},initMap:function(a){a.render()}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],7:[function(a,b){"use strict";var c=(a("underscore"),a("jquery")),d=a("backbone");d.$=a("jquery");var e;b.exports=d.View.extend({el:"<div />",gMap:null,$map:null,markers:[],positionMarker:null,searchBox:null,constructor:function(a){d.View.apply(this,arguments),console.log("MapView:init()"),this.$map=c("#map-canvas"),this.initMap(),this.setPosition(a)},events:{},render:function(){return this.$el.html(e).attr("id","map-canvas"),this.$status=this.$el.find("#status"),this},loading:function(a){this.$el.find("#status").toggleClass("loading",a)},initMap:function(){var a={zoom:15,disableDefaultUI:!0,zoomControl:!0,scrollWheel:!1};this.gMap=new google.maps.Map(this.$map[0],a)},newMarker:function(a,b,c,d,e){var f=new google.maps.LatLng(a.latitude,a.longitude),c=c?c:"DROP";return d&&this.gMap.setCenter(f),void 0===e&&(e=!1),new google.maps.Marker({position:f,map:this.gMap,animation:google.maps.Animation[c.toUpperCase()],icon:"/img/marker-"+b+".png",draggable:e})},deleteMarker:function(a){a.setMap(null),a=null},setPosition:function(a){this.positionMarker&&(google.maps.event.clearInstanceListeners(this.positionMarker),this.positionMarker.setMap(null),this.positionMarker=null),this.positionMarker=this.newMarker(a,"me","bounce",!0,!0);var b=this;google.maps.event.addListener(this.positionMarker,"dragend",function(){var a={latitude:b.positionMarker.getPosition().lat(),longitude:b.positionMarker.getPosition().lng()};window.app.currentPosition=a,window.app.router.navigate("terminals/list/"+window.app.currentRadius+"/"+a.latitude+"/"+a.longitude,!0)})},centerMap:function(a){this.gMap.setCenter(a)},refresh:function(a){var b=new google.maps.LatLng(a.latitude,a.longitude);this.setPosition(a),this.centerMap(b),console.log("refresh")},initSearchBox:function(){var a=document.getElementById("addressBox");this.searchBox=new google.maps.places.Autocomplete(a),this.searchBox.bindTo("bounds",this.gMap)},getSearchPostion:function(){var a=this.searchBox.getPlace();if(a){var b=new google.maps.LatLng(a.geometry.location.k,a.geometry.location.D);return this.centerMap(b),{coords:b,address:a.formatted_address}}return!1}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],8:[function(a,b){"use strict";var c=(a("underscore"),a("jquery")),d=a("backbone"),e=a("jeyo-distans");d.$=a("jquery");var f;b.exports=d.View.extend({el:"<aside />",constructor:function(a){d.View.apply(this,arguments),this.model=a,console.log("TerminalDetailsView:init()"),f||(f=c("#tpl-details").remove().text())},events:{"click .showProblems":"showProblems","click #empty_terminal":"toggleEmptyState","click #modif_terminal":"editTerminal","click #save_terminal":"saveTerminal"},render:function(){var a=this.model.get("bank"),b={latitude:this.model.get("latitude"),longitude:this.model.get("longitude")},c=this.model.get("empty")?"empty":"money";return window.app.map.markers.push(window.app.map.newMarker({latitude:b.latitude,longitude:b.longitude},c,"DROP",!0)),this.$el.attr("class","col1").html(f).find("h2").css("background","#"+(a&&a.color?a.color:"333")).end().find(".triangle").css("border-top-color","#"+(a&&a.color?a.color:"333")).end().find("h2 strong").text(a&&a.name?a.name:"Inconnu").end().find("img").attr("src",a&&a.icon?"/banks/"+a.icon:"/banks/unknown.png").attr("alt",a&&a.name?a.name:"Inconnu").end().find(".distance").text("~"+parseInt(1e3*e(b,window.app.currentPosition))+"m").end().find("address").text(this.model.get("address")).end().find(".problem").toggle(this.model.get("empty")).end().find(".problems-container").toggle(!this.model.get("empty")).end().find(".problems").toggle(this.model.get("empty")).end(),this},showProblems:function(a){a.preventDefault(),c(".problems").toggle()},toggleEmptyState:function(a){a.preventDefault();var b=this;window.confirm("Voulez vous vraiment mettre ce distributeur à jour ?")&&(this.model.set("empty",!0),this.model.save(null,{url:"/api/terminals/"+this.model.get("id")+"/empty",success:function(){b.render()}}))},editTerminal:function(a){a.preventDefault(),c(".editInfo").toggle(),window.app.map.initSearchBox()},saveTerminal:function(){var a=window.app.map.getSearchPostion(),b=this;a?this.model.save(null,{url:"/api/terminals/"+this.model.get("id")+"/"+a.address+"/"+a.coords.lat()+"/"+a.coords.lng()+"/newaddress",success:function(){window.app.map.deleteMarker(window.app.map.markers[0]),window.app.router.showTerminalDetails(b.model.get("id"))}}):c("#error_address").show()}})},{backbone:"backbone","jeyo-distans":"jeyo-distans",jquery:"jquery",underscore:"underscore"}],9:[function(a,b){"use strict";var c=(a("underscore"),a("jquery")),d=a("backbone"),e=a("jeyo-distans");d.$=a("jquery");var f;b.exports=d.View.extend({el:"<li />",constructor:function(a){d.View.apply(this,arguments),this.model=a,f||(f=c("#tpl-result-list-elt").remove().text())},events:{"click a":"showTerminal"},render:function(){var a=this.model.get("bank"),b={latitude:this.model.get("latitude"),longitude:this.model.get("longitude")},c=this.model.get("empty")?"empty":"money",d=this,g=window.app.map.newMarker({latitude:this.model.get("latitude"),longitude:this.model.get("longitude")},c);return google.maps.event.addListener(g,"click",function(){window.app.map.centerMap(g.getPosition()),window.app.router.navigate("terminals/details/"+d.model.get("id"),!0)}),window.app.map.markers.push(g),this.$el.html(f).find("a").find("img").attr("src",a&&a.icon?"/banks/"+a.icon:"/banks/unknown.png").attr("alt",a&&a.name?a.name:"Inconnu").end().find("strong").css("color","#"+(a&&a.color?a.color:"333")).text(a&&a.name?a.name:"Inconnu").end().find("span.distance").text("~"+parseInt(1e3*e(b,window.app.currentPosition))+"m"),this},showTerminal:function(a){a.preventDefault(),window.app.router.navigate("terminals/details/"+this.model.get("id"),!0)}})},{backbone:"backbone","jeyo-distans":"jeyo-distans",jquery:"jquery",underscore:"underscore"}],10:[function(a,b){"use strict";var c=(a("underscore"),a("jquery")),d=a("backbone");d.$=a("jquery");var e,f=a("./terminals-list-element");b.exports=d.View.extend({el:"<aside />",constructor:function(a){d.View.apply(this,arguments),this.collection=a,console.log("TerminalListView:init()"),e||(e=c("#tpl-result").remove().text())},events:{"change #radius":"changeRadius"},setStatus:function(a){this.$el.find("#status .text").text(a)},render:function(){this.$el.attr("class","col1").html(e);var a=this.$el.find("ul");return this.$el.find("#radius").val(window.app.currentRadius),this.collection.each(function(b){new f(b).render().$el.appendTo(a)}),this},changeRadius:function(a){window.app.currentRadius=a.target.value,window.app.router.navigate("terminals/list/"+window.app.currentRadius+"/"+window.app.currentPosition.latitude+"/"+window.app.currentPosition.longitude,!0)}})},{"./terminals-list-element":9,backbone:"backbone",jquery:"jquery",underscore:"underscore"}]},{},[1]);
//# sourceMappingURL=app.min.js.map